#set($hits = $publishingentityassethits)
#if(!$ismodulesearch)
	#set ( $ismodulesearch = $content.get("ismodulesearch") )
#end
#if(!$ismodulesearch)
	#set ( $ismodulesearch = $context.getRequestParameter("ismodulesearch") )
#end
#if(!$publishingid)
	#set ( $publishingid = $context.getRequestParameter("publishingid") )
#end

<div id="resultsdiv" class="scroll-resultsdiv"
	data-hitssessionid="$!hits.getSessionId()" ##it breaks drag&drop
	data-hitsname="$!hits.getHitsName()"
	data-componenthome="$!componenthome"
	data-searchhome="$!home$!{componenthome}/results"
	data-category="$!category.getId()"
	data-collectionid="$!librarycol.getId()" 
	data-publishingid="$!publishingid"
	data-rendertype="$!rendertype"
	data-searchtype="asset" 
	data-pagenum="$!hits.getPage()" 
	data-totalpages="$!hits.getTotalPages()"
	data-module="$!module"
	data-section="$!content.section"
	#set( $inputid = $context.getRequestParameter("inputid"))
	data-inputid="$!inputid"
	data-ismaingrid="true"
	data-stackedviewpath="/$!mediadbappid/services/publishingdestination/gallery/results.html">


	#if( $hideheader &&  $hideheader != "true")
		$pages.include("$componenthome/results/header.html",$context) 
	#end
	<div class="scrollview">
		<div class="masonry-grid2" 
			data-maxheight="180" 
			data-maxwidth="180"
			data-targeth="180"
			data-cellpadding="4">
		
		#set($count = 0)
		#set($viewerlink = $content.get("assetviewerlink") )
		#set($stackedfield = $mediaarchive.getCatalogSettingValue("stackedgalleryfield"))
		
		#foreach( $brick in $hits.getPageOfHits())
		 
		 	#ifnotnull( $hitassetlookup )
			 	#set( $hit = $hitassetlookup.get($brick.getId()) )
		 	#end
		 	#ifnull( $hitassetlookup )
				#set( $hit = $brick)
		 	#end
			$context.putPageValue("brick", $brick)
			$context.putPageValue("hit", $hit)
			$context.putPageValue("asset", $hit)
			
			#set($type = $hit.getSearchHit().getType())
			#set($rendertype = $mediaarchive.getMediaRenderType($hit.fileformat))
			$context.putPageValue("type", $rendertype)
			
			$context.putPageValue("assetid", $hit.id)
			$context.putPageValue("count", $count )
			$context.putPageValue("sourcepath", $hit.sourcepath )
			$context.putPageValue("thumbsize", "mediumplus" )
			
			#set($sourcepath = $hit.sourcepath)
			#set($assetwidth = $mediaarchive.getRealImageWidth($hit))
			#set($assetheight = $mediaarchive.getRealImageHeight($hit))
			#set($click = "$siteroot$viewerlink?hitssessionid=${hits.getSessionId()}&assetid=$!{hit.id}")
			#set($isselected = $!hits.isSelectedOnPage($!{hit.id}) )
		       
			<div class="masonry-grid-cell" 
				id="gallerycell_$!{hit.id}"
				data-assetid="$!{hit.id}"
				#if($rendertype == "audio")
					data-width="250"
					data-height="110"
				#else
					data-width="$assetwidth"
					data-height="$assetheight"
					$context.putPageValue("thumbheight", "180" ) 
				#end
				>
				<div class="grid-cell-hover"></div>
				##<div class="grid-gallery-checked"></div>
				#if(!$rendertype || $type =="rendertype")
					#set( $rendertype = "mime" )
				#elseif( $rendertype =="video" || $rendertype =="document")
					#set( $rendertype = "image" )
				#end
				#set($convertpreset = $mediaarchive.getCachedData("convertpreset", "largeimage" ) )
				#set($downloadlink = $mediaarchive.asLinkToDownload($hit, $!librarycol.id, $convertpreset))
				$context.putPageValue("downloadlink", $downloadlink)
				<div class="grid-thumbimage " data-assetid="$!hit.id" data-rendertype="$!rendertype">
					$pages.include("/$!mediadbappid/services/publishingdestination/gallery/rendertype/$!{rendertype}.html", $context)
				</div>
				
				
				
				<div class="grid-cell-footer"><a class="downloadicon" href="${downloadlink}" title="[[Download]] $!hit.getName()"><span>[[Download]]</span></a></div>
			    
			    ##Caption
			    #if(false)
				<div class="draggholder grid-caption grid-caption-${rendertype} #if($rendertype=="default") grid-caption-show #end">
					#if($stackedfield)
						#set($title = $hit.get($stackedfield))
						#end
						#if(!$title)		         	
						#if( $hit.assettitle )
							#set($title =  $hit.assettitle) 
						#else 
							#set($title = $hit.name) 
						#end
						#end
						<a class="stackedplayer grid-caption-link" id="clickid${hit.id}" data-assetid="$hit.id" href="#" title="#esc($!title)">
						$context.putPageValue("data",$hit)	
						$context.putPageValue("searcher",$mediaarchive.getAssetSearcher() )	
						$context.putPageValue("view", "asset/stackedgallery")
						##$pages.include("/$applicationid/components/xml/detailviewer-stackedgallery.html", $context)
					</a>
					
					<div class="grid-gallery-footer d-flex align-items-center justify-content-between"> 
						<span>
							#if ($hit.assetaddeddate)
								$!context.getDate($hit.assetaddeddate)
							#end
						</span>
						<div class="d-flex align-items-center">
							   	<a href="$dlink" 
							   		class="emdialog" data-assetid="$hit.id" data-hidefooter="true" title="[[Download]] $!title">
							       download
							    </a>
						</div>
					</div>
				</div>
				#end
			</div>
		    #set ( $count = $count + 1) 
		#end
		
	</div>
	</div>
</div>