<div class="page-header">
  <h1>$data </h1>
  URL ($data.httpmethod): 
  <input id="url" class="form-control"  type="text" value="$content.replaceProperty( $data.url )" size="50"/> 
</div>
<i>$!data.caption</i>
<div id="jsontext" style="display: none;">
#if ($data.samplerequest)
$data.samplerequest
#end
</div>

<form name="requestform" id="requestform">

#if($data.httpmethod=="POST" || $data.httpmethod=="PUT")
#set($displayreq = true)
#end
<h2 class="mt-4">Request</h2>
<div class="editor-wrapper codeEditor">
	<div class="controls" style="display: none;">
		<div class="d-flex">
			<div class="status"><i class='bi bi-check-circle'></i></div>
			<button class="copyJSON" type="button"><i class="bi bi-clipboard"></i></button>
			<div class="d-flex flex-column">
				<button class="theme-toggle" type="button" title="Toggle dark/light theme"><i class="bi bi-moon"></i></button>
				<button class="formatJSON" type="button"><i class="bi bi-code-square"></i></button>
				<button class="minifyJSON" type="button"><i class="bi bi-body-text"></i></button>
			</div>
		</div>
	</div>
				
	<textarea name="jsonrequest" 
	#if(!$displayreq) style="display: none;" #end 
	id="request"
	class="form-control" data-method="${data.httpmethod}" 
	rows="6"></textarea>
	<div class="error-message"></div>
</div>


#foreach( $toupload in $data.getValues("filefieldstoupload"))

<input type="file" name="$toupload"  id="$toupload"/>

#end

</form>
<button class="btn btn-success" id="process">Execute</button>

<div class="d-flex align-items-center mt-4">
	<h2 class="my-0 mr-3">[[Response]]</h2>
	<span class="text-success" id="timing"></span>
</div>


<div id="responsearea" class="row">
	<div class="col-sm-12">
		<div class="editor-wrapper codeEditor">
			<div class="controls" style="display: none;">
				<div class="d-flex">
					<div class="status"><i class='bi bi-check-circle'></i></div>
					<button class="copyJSON" type="button"><i class="bi bi-clipboard"></i></button>
					<div class="d-flex flex-column">
						<button class="theme-toggle mt-0" type="button" title="Toggle dark/light theme"><i class="bi bi-moon"></i></button>
						<button class="formatJSON" type="button"><i class="bi bi-code-square"></i></button>
						<button class="minifyJSON" type="button"><i class="bi bi-body-text"></i></button>
					</div>
				</div>
			</div>
				
			<textarea id="response" class="form-control" rows="20"></textarea>
			<div class="error-message"></div>
		</div>
	</div>
	<div class="col-sm-6 d-none">
		<textarea id="testraw" class="form-control" disabled rows="20"></textarea>
	</div>
</div>

<script type="text/javascript">
$(document).ready(function(){

	function initEditor(target) {
		target.jsonCodeEditor();
	}

	var original = $("#jsontext").html().trim();
	if (original) {
		var data = JSON.parse(original);
		var string = JSON.stringify(data, undefined, 2);
		$("#request").val(string);
		initEditor($("#request").closest(".codeEditor"));
	}

	var jsonResponse = false;

	$("#process").on("click", function () {
		var req = $("#request").val();
		var url = $("#url").val();
		var method = $("#request").data("method");
		const start = performance.now();

		var always = function () {
			const end = performance.now();
			var logmsg = `Took ${(end - start).toFixed(2)} ms`;
			console.log(logmsg);
			$("#timing").text(logmsg);
		};

    #if( $data.getValues("filefieldstoupload") )
			var data = new FormData($("#requestform")[0]);

			$.ajax({
				url: url,
					data: data,
					cache: false,
					contentType: false,
					processData: false,
					dataType:'text',
					type: method,
					error: function(data)
			{
				//errors are always objects
				var text  = JSON.stringify(data,undefined, 2);    
				$("#response").val(text);
			},
			success: success
		}).always(always);
    #else

			jsonResponse = true;
	    jQuery.ajax({
				contentType: 'application/json',
	    	type: method,
				url: url,
				data: req,
				dataType:'text',
				error: function(data)
				{
					//errors are always objects
					var text  = JSON.stringify(data,undefined, 2);    
					$("#response").val(text);
			 
					initEditor($("#response").closest(".codeEditor"));
				},
				success: success
	    }).always(always);
		#end
});


success = function (text) {
	if (text) {
		try {
			// $("#testraw").val(text);
			var data = JSON.parse(text);
			text = JSON.stringify(data, undefined, 2);
		} catch (ex) {
			text = JSON.stringify(ex);
		}
	} else {
		text = JSON.stringify("Nothing returned");
	}
	$("#response").val(text);
	if(jsonResponse)
	{ 
		initEditor($("#response").closest(".codeEditor"));
	}
};

	
});

</script>